name: validate

on:
  workflow_call:
    inputs:
      target_env:
        required: false
        type: string
        default: 'dev'

  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - 'release/*'
      - 'hotfix/*'
      - 'main'
  workflow_dispatch:

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'

jobs:
  # job 1: validate branch policy
  validate-branch-policy:
    runs-on: ubuntu-latest
    steps:
      - name: Block invalid PR path
        if: |
          github.event_name == 'pull_request' &&
          !(
            (startsWith(github.event.pull_request.head.ref, 'feature/') && startsWith(github.event.pull_request.base.ref, 'release/')) ||
            (startsWith(github.event.pull_request.head.ref, 'feature/') && startsWith(github.event.pull_request.base.ref, 'hotfix/')) ||
            (startsWith(github.event.pull_request.head.ref, 'release/') && github.event.pull_request.base.ref == 'main') ||
            (startsWith(github.event.pull_request.head.ref, 'hotfix/') && github.event.pull_request.base.ref == 'main')
          )
        run: |
          echo "::error::Invalid PR Path"
          exit 1

      - name: Check if target branch is locked
        if: |
          github.event_name == 'pull_request' &&
          (startsWith(github.base_ref, 'release/') || startsWith(github.base_ref, 'hotfix/'))
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"
          OPEN_PRS=$(gh pr list --repo "${{ github.repository }}" --base main --head "$TARGET_BRANCH" --state open --json number --jq 'length')
          if [ "$OPEN_PRS" -gt 0 ]; then
            echo "::error::Validation Failed: Branch '$TARGET_BRANCH' is LOCKED."
            exit 1
          fi

      - name: Approve valid PR path
        if: github.event_name == 'pull_request'
        run: echo "PR Path Validated"

      - name: Approve Manual Run
        if: github.event_name == 'workflow_dispatch'
        run: echo "Manual validation run."

  # job 2: Lint code
  lint-code:
    needs: validate-branch-policy
    runs-on: windows-2022 
    steps:
      - uses: actions/checkout@v4
      - name: Run Linter
        shell: pwsh
        run: Write-Host "Linting passed."

  # job 3: Build Project
  build-project:
    needs: lint-code
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    
    # Dynamic Environment Selection
    environment: ${{ inputs.target_env || 'dev' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- NEW DEBUG STEP ---
      - name: Debug Environment Context
        # We must map secrets to env vars to check their existence in PowerShell
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          Write-Host "=========================================="
          Write-Host "     DEPLOYMENT CONTEXT DEBUG INFO        "
          Write-Host "=========================================="
          
          # 1. Print the Active Environment Name
          # Logic: If inputs.target_env is empty (PR run), it prints 'dev'
          $currentEnv = "${{ inputs.target_env }}"
          if ([string]::IsNullOrEmpty($currentEnv)) { $currentEnv = "dev" }
          Write-Host "Active Environment : $currentEnv"
          
          # 2. Verify Secret Availability (Safe Check)
          Write-Host "Checking Secrets Availability..."
          
          if (-not [string]::IsNullOrEmpty($env:GOOGLE_CLIENT_ID)) {
              Write-Host "[-] GOOGLE_CLIENT_ID     : [LOADED] (Masked)" -ForegroundColor Green
          } else {
              Write-Host "[-] GOOGLE_CLIENT_ID     : [MISSING] or Empty" -ForegroundColor Red
          }

          if (-not [string]::IsNullOrEmpty($env:GOOGLE_CLIENT_SECRET)) {
              Write-Host "[-] GOOGLE_CLIENT_SECRET : [LOADED] (Masked)" -ForegroundColor Green
          } else {
              Write-Host "[-] GOOGLE_CLIENT_SECRET : [MISSING] or Empty" -ForegroundColor Red
          }
          Write-Host "=========================================="
      # ----------------------

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Configure and Build
        # Inject Secrets here so CMake can read them
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-app
          path: build/
          retention-days: 1

  # job 4: Run Unit Tests
  run-unit-tests:
    needs: build-project
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    
    environment: ${{ inputs.target_env || 'dev' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # --- NEW DEBUG STEP (Repeated for visibility in Test Job) ---
      - name: Debug Environment Context
        env:
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        run: |
          Write-Host "Current Environment: ${{ inputs.target_env || 'dev' }}"
          if ($env:GOOGLE_CLIENT_ID) { Write-Host "Secret GOOGLE_CLIENT_ID is available." }
      # ------------------------------------------------------------

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: compiled-app
          path: build

      - name: Run Unit Tests
        env:
           GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
           GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        run: |
          cd build
          ctest -C Release --output-on-failure