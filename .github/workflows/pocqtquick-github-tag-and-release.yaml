name: pocqtquick-github-tag-and-release

# Trigger only when a PR to 'main' is closed
on:
  pull_request:
    types: [closed]
    branches:
      - 'main'

permissions:
  contents: write      # Required to push tags and upload assets to releases
  pull-requests: read  # Required to read PR body for version info

jobs:
  # Job 1 : versioning and release creation
  create-tag-and-release:
    # Run only if the PR was merged and came from the 'release' branch
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'release'
    runs-on: ubuntu-latest
    
    # We define outputs to pass data (like the version tag) to the next job
    outputs:
      new_tag: ${{ steps.new_tag.outputs.new_tag }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: 'main'
          fetch-depth: 0 

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine Version Bump
        id: version_bump
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if echo "$PR_BODY" | grep -q '\[x\] Major'; then
            echo "bump_type=major" >> $GITHUB_OUTPUT
          elif echo "$PR_BODY" | grep -q '\[x\] Minor'; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          elif echo "$PR_BODY" | grep -q '\[x\] Patch'; then
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          else
            echo "No version bump type selected in PR body. ([x] Major, [x] Minor, or [x] Patch)."
            exit 1
          fi

      - name: Get latest tag
        id: last_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag --list 'v*.*.*' --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            echo "No previous vX.Y.Z tag found. Starting from v0.0.0."
            LATEST_TAG="v0.0.0"
          fi
          echo "last_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Calculate new tag
        id: new_tag
        run: |
          BUMP_TYPE=${{ steps.version_bump.outputs.bump_type }}
          LAST_TAG=${{ steps.last_tag.outputs.last_tag }}
          VERSION=${LAST_TAG#v}
          IFS='.' read -r -a parts <<< "$VERSION"
          MAJOR=${parts[0]}
          MINOR=${parts[1]}
          PATCH=${parts[2]}
          
          # Increment based on bump type
          case "$BUMP_TYPE" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "New tag will be: $NEW_TAG"

      - name: Create and push new tag
        # No PAT needed here since we are in the same workflow run!
        run: |
          NEW_TAG=${{ steps.new_tag.outputs.new_tag }}
          MERGE_COMMIT_SHA=${{ github.event.pull_request.merge_commit_sha }}
          
          echo "Tagging commit $MERGE_COMMIT_SHA as $NEW_TAG"
          git tag $NEW_TAG $MERGE_COMMIT_SHA
          git push origin $NEW_TAG

      - name: Extract Release Summary
        id: extract_summary
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Use an awk "state machine" to extract text between the two markers.
          # We use "<<<" (a "here string") to safely pass the multiline $PR_BODY to awk.
          # We must escape the '*' characters with '\' for the regex.
          
          # 1. /\*\*Release Summary\*\*/{f=1; next} : When we see the START marker, set flag 'f' to 1 and skip to the next line.
          # 2. /\*\*Version Bump Type\*\*/{f=0}      : When we see the END marker, set flag 'f' to 0.
          # 3. f                                 : If flag 'f' is 1 (true), print the current line.
          SUMMARY=$(awk '/\*\*Release Summary\*\*/{f=1; next} /\*\*Version Bump Type\*\*/{f=0} f' <<< "$PR_BODY")

          # Use multiline string syntax for GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_TAG: ${{ steps.new_tag.outputs.new_tag }}
          SUMMARY: ${{ steps.extract_summary.outputs.summary }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Check if summary is empty, and provide a default
          if [ -z "$SUMMARY" ]; then
            echo "Release summary was empty. Using PR title as notes."
            RELEASE_NOTES="$PR_TITLE"
          else
            RELEASE_NOTES="$SUMMARY"
          fi
          
          # Create Release and capture output
          gh release create $NEW_TAG \
            --title "$NEW_TAG" \
            --notes "$RELEASE_NOTES" \
            --target ${{ github.event.pull_request.merge_commit_sha }} \
            --latest

          # Save upload URL for next job (optional, but good practice)
          echo "upload_url=$(gh release view $NEW_TAG --json uploadUrl -q .uploadUrl)" >> $GITHUB_OUTPUT

  # JOB 2: build windows installer and upload to release
  build-windows-installer:
    needs: create-tag-and-release
    if: needs.create-tag-and-release.outputs.new_tag != ''
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    
    env:
      QT_VERSION: '6.10.1'
      QT_ARCH: 'win64_msvc2022_64'
      APP_EXECUTABLE: 'counter_app.exe'
      PACKAGE_DOMAIN: 'com.pocqtquick'
      BUILD_EXE_PATH: 'build/source/Release/counter_app.exe' 
      QML_SOURCE_DIR: 'source/ui'
      
      # 1. DEFINE THE VERSION AND FILENAME HERE ONCE
      RELEASE_VERSION: ${{ needs.create-tag-and-release.outputs.new_tag }}
      WINDOWS_INSTALLER_NAME: "pocqtquick-${{ needs.create-tag-and-release.outputs.new_tag }}-Windows-x64.exe"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_VERSION }}

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt and IFW
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'
          tools: 'tools_ifw'

      - name: Configure and Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

      - name: Stage Files for Installer
        run: |
          $targetDir = "installer\packages\$env:PACKAGE_DOMAIN\data"
          New-Item -ItemType Directory -Force -Path $targetDir
          Copy-Item -Path "$env:BUILD_EXE_PATH" -Destination $targetDir

      - name: Run Windeployqt
        run: |
          $targetExe = "installer\packages\$env:PACKAGE_DOMAIN\data\$env:APP_EXECUTABLE"
          windeployqt --release --compiler-runtime --no-translations --no-opengl-sw --qmldir $env:QML_SOURCE_DIR $targetExe

      - name: Create Installer
        run: |
          $binCreator = Get-ChildItem -Path "..\Qt\Tools\QtInstallerFramework\*\bin\binarycreator.exe" | Select-Object -First 1 -ExpandProperty FullName

          if (-not $binCreator) {
            Write-Error "binarycreator.exe not found!"
            exit 1
          }

          Write-Host "Using binarycreator: $binCreator"
          
          # 2. USE THE VARIABLE HERE
          Write-Host "Building Installer: $env:WINDOWS_INSTALLER_NAME"

          cd installer
          & $binCreator -c config\config.xml -p packages\ $env:WINDOWS_INSTALLER_NAME

      - name: Upload Installer to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          # 3. USE THE VARIABLE HERE (Note: must include the folder path)
          files: installer/${{ env.WINDOWS_INSTALLER_NAME }}