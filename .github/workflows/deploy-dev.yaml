name: deploy-dev

# trigger: Manual run only (on any branch)
on:
  workflow_dispatch:

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'
  APP_EXECUTABLE: 'appCounterApp.exe'
  # We don't strictly need PACKAGE_DOMAIN for Inno, but keeping it for consistency
  PACKAGE_DOMAIN: 'com.pocqtquick' 
  QML_SOURCE_DIR: 'src/ui'

jobs:
  # job 1: validation and build
  validation:
    uses: ./.github/workflows/validate.yaml
    with:
      target_env: 'dev'
    secrets: inherit

  # job 2: generate timestamp
  generate-timestamp:
    needs: validation
    runs-on: ubuntu-latest
    outputs:
      ts: ${{ steps.time.outputs.ts }}
    steps:
      - name: Generate Timestamp
        id: time
        run: |
          TS=$(date +'%Y%m%d%H%M%S')
          echo "ts=$TS" >> $GITHUB_OUTPUT
          echo "Generated Timestamp: $TS"

  # job 3: deploy for windows
  deploy-app-windows:
    needs: [validation, generate-timestamp]
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Qt (Deploy Tool)
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: compiled-app
          path: download_temp

      - name: Run Windeployqt
        run: |
          # Simplified: Create a clean "dist" directory for the staged app
          $targetDir = "dist"
          New-Item -ItemType Directory -Force -Path $targetDir

          $exePath = Get-ChildItem -Path "download_temp" -Filter $env:APP_EXECUTABLE -Recurse | Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $exePath) { Write-Error "Exe not found"; exit 1 }

          Move-Item -Path $exePath -Destination $targetDir

          $stagedExe = "$targetDir\$env:APP_EXECUTABLE"
          windeployqt --release --compiler-runtime --no-translations --no-opengl-sw --qmldir $env:QML_SOURCE_DIR $stagedExe
          
          Remove-Item "$targetDir\*.obj", "$targetDir\*.cpp", "$targetDir\*.h", "$targetDir\*.cmake" -ErrorAction SilentlyContinue

      - name: Upload Staged Package
        uses: actions/upload-artifact@v4
        with:
          name: staged-package
          # Upload the clean dist folder
          path: dist
          retention-days: 1

  # job 4: create application zip (Raw binaries, no installer)
  create-application-zip:
    needs: [deploy-app-windows, generate-timestamp]
    runs-on: windows-2022
    steps:
      - name: Download Staged Package
        uses: actions/download-artifact@v4
        with:
          name: staged-package
          path: staged-data

      - name: Upload Application Zip
        uses: actions/upload-artifact@v4
        with:
          name: pocqtquick-dev-app-${{ needs.generate-timestamp.outputs.ts }}
          path: staged-data
          retention-days: 5

  # job 5: create installer zip (Inno Setup)
  create-installer-zip:
    needs: [deploy-app-windows, generate-timestamp]
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
      
      # 1. Install Inno Setup via Chocolatey
      - name: Install Inno Setup
        run: choco install innosetup --no-progress

      # 2. Download the binaries we prepared in Job 3
      - name: Download Staged Package
        uses: actions/download-artifact@v4
        with:
          name: staged-package
          path: staged-data

      # 3. Run the Inno Setup Compiler (ISCC)
      - name: Build Installer
        run: |
          $ts = "${{ needs.generate-timestamp.outputs.ts }}"
          $installerName = "pocqtquick-dev-installer-$ts"
          
          # 1. Get the Absolute Path to the staged-data folder
          # This prevents the "installer/staged-data" path error
          $absSourceDir = (Resolve-Path "staged-data").Path
          Write-Host "Inno Source Dir: $absSourceDir"

          # 2. Run Compiler with Absolute Path AND Enforced Exe Name
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "/DMyAppSourceDir=$absSourceDir" `
            "/DMyAppExeName=$env:APP_EXECUTABLE" `
            "/DMyOutputFilename=$installerName" `
            installer/windows-setup.iss
          
          if (Test-Path "installer/Output/$installerName.exe") {
             Write-Host "Installer created successfully."
          } else {
             Write-Error "Installer generation failed."
             exit 1
          }

      - name: Upload Installer Exe
        uses: actions/upload-artifact@v4
        with:
          name: pocqtquick-dev-installer-${{ needs.generate-timestamp.outputs.ts }}
          path: installer/Output/*.exe
          retention-days: 5