name: Windows Installer Build (MSVC)

on: [push, pull_request]

env:
  # Qt Settings
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'
  
  # Project Specifics
  APP_EXECUTABLE: 'counter_app.exe'
  PACKAGE_DOMAIN: 'com.pocqtquick'
  # Note: Adjust this build path if your CMakeLists.txt structure changes
  BUILD_EXE_PATH: 'build/source/Release/counter_app.exe' 
  QML_SOURCE_DIR: 'source/ui'

jobs:
  build:
    runs-on: windows-2022

    # Using Bash on Windows makes path handling much safer
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup MSVC Environment
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 2. Install Qt + Installer Framework (IFW)
      # 'tools_ifw' automatically installs the latest IFW (approx 4.10.x) and adds it to PATH
      - name: Install Qt and IFW
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'       # Kept from your original snippet
          tools: 'tools_ifw'         # This replaces the manual download script

      # 3. Configure and Build
      - name: Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      # 4. Run Unit Tests
      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

      # 5. Stage Files for Installer
      - name: Copy Files for Packaging
        run: |
          # Define target directory
          TARGET_DIR="installer/packages/${{ env.PACKAGE_DOMAIN }}/data"
          
          # Create directory structure
          mkdir -p "$TARGET_DIR"
          
          # Copy executable
          cp "${{ env.BUILD_EXE_PATH }}" "$TARGET_DIR/"

      # 6. Run Windeployqt
      - name: Run Windeployqt
        run: |
          TARGET_EXE="installer/packages/${{ env.PACKAGE_DOMAIN }}/data/${{ env.APP_EXECUTABLE }}"
          
          # Added --compiler-runtime to ensure VCRUNTIME140.dll is included
          windeployqt --release --compiler-runtime --no-translations --no-opengl-sw --qmldir ${{ env.QML_SOURCE_DIR }} "$TARGET_EXE"

      # 7. Create Installer
      - name: Create Installer
        run: |
          # 1. Locate binarycreator.exe
          # We search inside the 'Qt/Tools' folder at the workspace root
          # The 'ls' command with wildcards finds the version folder automatically (e.g., 4.10 or 4.10.0)
          BC_PATH=$(ls ../Qt/Tools/QtInstallerFramework/*/bin/binarycreator.exe | head -n 1)

          if [ -z "$BC_PATH" ]; then
            echo "Error: binarycreator.exe not found!"
            # Debug: List what IS inside Tools to help troubleshoot
            ls -R ../Qt/Tools
            exit 1
          fi

          echo "Found binarycreator at: $BC_PATH"

          # 2. Enter the installer directory
          cd installer

          # 3. Run the tool using the explicit path
          "$BC_PATH" --offline-installer "pocqtquick.exe" -c config/config.xml -p packages/

      # 8. Upload Installer Artifact
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: installer/pocqtquick.exe