name: Windows Installer Build (MSVC)
on: [push, pull_request]

jobs:
  build:
    runs-on: windows-2022

    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install Qt 6.10.0 + Installer Framework (Required for binarycreator)
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.10.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qt5compat'
          tools: 'tools_ifw'

      # 2. Setup MSVC Environment
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 3. Configure and Build
      - name: Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      # 4. Run Unit Tests
      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

      # 5. Prepare Packaging
      - name: Copy Files for Packaging
        run: |
          cmake -E make_directory "installer/packages/com.pocqtquick/data"
          cmake -E copy "build/source/Release/counter_app.exe" "installer/packages/com.pocqtquick/data/"

      # 6. Run windeployqt
      - name: Run Windeployqt
        run: |
          windeployqt --release --no-translations --no-opengl-sw --qmldir source\ui installer\packages\com.pocqtquick\data\counter_app.exe

      # 7. Create Installer (find IFW path using install-qt-action variables)
      - name: Create Installer
        shell: pwsh
        run: |
          Write-Host "Searching for Qt Installer Framework..."

          $ifwRoot = Join-Path "${{ github.workspace }}" "Qt\Tools\QtInstallerFramework"
          if (-not (Test-Path $ifwRoot)) {
            Write-Error "Qt Installer Framework not found at $ifwRoot"
            exit 1
          }

          Write-Host "IFW root found: $ifwRoot"

          # Find binarycreator.exe in all version folders
          $binaryCreator = Get-ChildItem -Path $ifwRoot -Recurse -Filter "binarycreator.exe" | Select-Object -First 1

          if (-not $binaryCreator) {
            Write-Error "binarycreator.exe not found anywhere under $ifwRoot"
            exit 1
          }

          Write-Host "Using binarycreator: $($binaryCreator.FullName)"

          & $binaryCreator.FullName -c installer\config\config.xml -p installer\packages pocqtquick.exe



      # 8. Upload Installer Artifact
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: pocqtquick.exe
