name: Windows Installer Build (MSVC)
on: [push, pull_request]

jobs:
  build:
    runs-on: windows-2022 # Explicitly use Windows 2022 image

    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install Qt 6.10.0 for MSVC 2022
      - name: Install Qt
        uses: jurplel/install-qt-action@v3 # v4 is not standard yet, v3 is safe
        with:
          version: '6.10.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'      # <--- USING MSVC NOW
          modules: 'qt5compat'           # Add modules if your app needs them

      # 2. Setup MSVC Environment (Critical for finding the compiler)
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 3. Configure and Build (The MSVC Way)
      - name: Build Application
        run: |
          mkdir build
          cd build
          :: We use "Visual Studio 17 2022" generator
          cmake .. -G "Visual Studio 17 2022" -A x64
          
          :: Build the Release configuration
          cmake --build . --config Release

      # 4. Run Unit Tests
      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

     # 5. Prepare Packaging
      - name: Copy Files for Packaging
        run: |
          :: Create the directory (:: is the comment syntax for cmd)
          cmake -E make_directory "installer/packages/com.pocqtquick/data"
          
          :: DEBUG: List files to find the correct exe name and path
          :: echo "Listing build directory contents:"
          :: dir /s build
          
          :: Copy the file (Update the exe name if needed!)
          cmake -E copy "build/source/Release/counter_app.exe" "installer/packages/com.pocqtquick/data/"

      # 6. Run Windeployqt
      # Note: We removed --compiler-runtime because MSVC uses system installed runtimes
      - name: Run Windeployqt
        run: |
          windeployqt --release --no-translations --no-opengl-sw --qmldir source\ui installer\packages\com.pocqtquick\data\counter_app.exe

      # 7. Generate the Installer (FAST METHOD)
      - name: Create Installer
        shell: cmd
        run: |
          :: The action stores the tools path in %IQTA_TOOLS%
          :: usually: C:\hostedtoolcache\windows\Qt\Tools
          
          echo "Tools Path is: %IQTA_TOOLS%"
          
          :: We look for the binarycreator inside that folder.
          :: The path pattern is usually: [ToolsPath]\QtInstallerFramework\[Version]\bin\binarycreator.exe
          :: Since we don't know the exact version number folder (e.g. 4.8), we use a wildcard match
          
          for /d %%d in ("%IQTA_TOOLS%\QtInstallerFramework\*") do (
            if exist "%%d\bin\binarycreator.exe" (
              "%%d\bin\binarycreator.exe" -c installer\config\config.xml -p installer\packages pocqtquick.exe
              exit 0
            )
          )
          
          echo "Error: binarycreator.exe not found in %IQTA_TOOLS%"
          exit 1

      # 8. Upload the result
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: pocqtquick.exe