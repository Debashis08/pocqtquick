name: Windows Installer Build (MSVC)
on: [push, pull_request]

jobs:
  build:
    runs-on: windows-2022

    defaults:
      run:
        shell: cmd

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Install Qt 6.10.0 + Installer Framework (Required for binarycreator)
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.10.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qt5compat'
          tools: 'tools_ifw'        # <<--- IMPORTANT: installs Qt Installer Framework

      # 2. Setup MSVC Environment
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      # 3. Configure and Build
      - name: Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      # 4. Run Unit Tests
      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

      # 5. Prepare Packaging
      - name: Copy Files for Packaging
        run: |
          cmake -E make_directory "installer/packages/com.pocqtquick/data"
          cmake -E copy "build/source/Release/counter_app.exe" "installer/packages/com.pocqtquick/data/"

      # 6. Run windeployqt
      - name: Run Windeployqt
        run: |
          windeployqt --release --no-translations --no-opengl-sw --qmldir source\ui installer\packages\com.pocqtquick\data\counter_app.exe

            # 7. Create Installer (find IFW path using install-qt-action variables)
      - name: Create Installer
        shell: pwsh
        run: |
          Write-Host "Looking for Qt IFW..."

          $ifw = $Env:IFW_ROOT

          if (-not $ifw) {
            Write-Error "Qt IFW not found. IFW_ROOT variable is missing."
            exit 1
          }

          $binaryCreator = Join-Path $ifw "bin/binarycreator.exe"

          if (-not (Test-Path $binaryCreator)) {
            Write-Error "binarycreator.exe not found at: $binaryCreator"
            exit 1
          }

          Write-Host "Using Binary Creator: $binaryCreator"

          & $binaryCreator -c installer\config\config.xml -p installer\packages pocqtquick.exe


      # 8. Upload Installer Artifact
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Installer
          path: pocqtquick.exe
