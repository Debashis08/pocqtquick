name: pocqtquick-windows-installer-build

# CHANGE 1: Trigger strictly when a Release is Published
on:
  release:
    types: [published]

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'
  APP_EXECUTABLE: 'counter_app.exe'
  PACKAGE_DOMAIN: 'com.pocqtquick'
  BUILD_EXE_PATH: 'build/source/Release/counter_app.exe' 
  QML_SOURCE_DIR: 'source/ui'
  # OPTIONAL: This variable now holds "v1.0.x" if you need it for your build scripts
  RELEASE_VERSION: ${{ github.event.release.tag_name }}

jobs:
  build:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # CHANGE 2: Explicitly checkout the tag associated with this release
          ref: ${{ github.event.release.tag_name }}

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt and IFW
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'
          tools: 'tools_ifw'

      - name: Configure and Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

      - name: Stage Files for Installer
        run: |
          $targetDir = "installer\packages\$env:PACKAGE_DOMAIN\data"
          New-Item -ItemType Directory -Force -Path $targetDir
          Copy-Item -Path "$env:BUILD_EXE_PATH" -Destination $targetDir

      - name: Run Windeployqt
        run: |
          $targetExe = "installer\packages\$env:PACKAGE_DOMAIN\data\$env:APP_EXECUTABLE"
          windeployqt --release --compiler-runtime --no-translations --no-opengl-sw --qmldir $env:QML_SOURCE_DIR $targetExe

      - name: Create Installer
        run: |
          $binCreator = Get-ChildItem -Path "..\Qt\Tools\QtInstallerFramework\*\bin\binarycreator.exe" | Select-Object -First 1 -ExpandProperty FullName

          if (-not $binCreator) {
            Write-Error "binarycreator.exe not found!"
            exit 1
          }

          Write-Host "Using binarycreator: $binCreator"
          Write-Host "Building Installer for Version: $env:RELEASE_VERSION"

          cd installer
          & $binCreator -c config\config.xml -p packages\ pocqtquick.exe

      # CHANGE 3: Simplified Upload for Release Event
      - name: Upload Installer to Release
        uses: softprops/action-gh-release@v2
        with:
          # This tells the action exactly which release to attach the file to
          tag_name: ${{ github.event.release.tag_name }}
          files: installer/pocqtquick.exe