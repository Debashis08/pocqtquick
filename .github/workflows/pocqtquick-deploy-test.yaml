name: QA Build (Release Branch)

on:
  pull_request:
    types: [closed]
    branches:
      - 'release'

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'
  APP_EXECUTABLE: 'counter_app.exe'
  PACKAGE_DOMAIN: 'com.pocqtquick'
  QML_SOURCE_DIR: 'source/ui'

jobs:
  # 1. BUILD
  build:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    outputs:
      timestamp: ${{ steps.time.outputs.ts }}
    steps:
      - name: Generate Timestamp (Build ID)
        id: time
        run: |
          $ts = Get-Date -Format "yyyyMMddHHmm"
          echo "ts=$ts" >> $env:GITHUB_OUTPUT
          Write-Host "Build Timestamp: $ts"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Configure and Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Upload Build Artifacts (Raw Binary)
        uses: actions/upload-artifact@v4
        with:
          name: compiled-binaries
          path: build/source/Release/counter_app.exe
          retention-days: 1

  # 2. TEST
  test:
    needs: build
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: compiled-binaries
          path: build/source/Release

      - name: Run Unit Tests
        run: |
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          ctest -C Release --output-on-failure

  # 3. PACKAGE (Updated for Separate Artifacts)
  package:
    needs: [build, test]
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    env:
      TS: ${{ needs.build.outputs.timestamp }}
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Qt and IFW
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          tools: 'tools_ifw'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: compiled-binaries
          path: staging

      - name: Run Windeployqt
        run: |
          $targetExe = "staging\$env:APP_EXECUTABLE"
          windeployqt --release --compiler-runtime --no-translations --no-opengl-sw --qmldir $env:QML_SOURCE_DIR $targetExe

      - name: Create Portable Zip
        run: |
          $zipName = "pocqtquick-QA-$env:TS-Portable.zip"
          Compress-Archive -Path "staging\*" -DestinationPath $zipName
          echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

      - name: Create Installer
        run: |
          $targetDir = "installer\packages\$env:PACKAGE_DOMAIN\data"
          New-Item -ItemType Directory -Force -Path $targetDir
          Copy-Item -Path "staging\*" -Destination $targetDir -Recurse

          $installerName = "pocqtquick-QA-$env:TS-Installer.exe"
          $binCreator = Get-ChildItem -Path "..\Qt\Tools\QtInstallerFramework\*\bin\binarycreator.exe" | Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $binCreator) { Write-Error "binarycreator.exe not found!"; exit 1 }
          
          cd installer
          & $binCreator -c config\config.xml -p packages\ $installerName
          
          Move-Item $installerName ..\
          echo "INSTALLER_NAME=$installerName" >> $env:GITHUB_ENV

      # --- CHANGED SECTION START ---
      
      # Upload 1: The Portable Zip
      - name: Upload Artifact - Portable Zip
        uses: actions/upload-artifact@v4
        with:
          # This sets the name of the artifact in the GitHub UI
          name: Portable-App-${{ env.TS }}
          path: ${{ env.ZIP_NAME }}
          retention-days: 5

      # Upload 2: The Installer Executable
      - name: Upload Artifact - Installer
        uses: actions/upload-artifact@v4
        with:
          # This sets a DIFFERENT name in the GitHub UI
          name: Windows-Installer-${{ env.TS }}
          path: ${{ env.INSTALLER_NAME }}
          retention-days: 5
          
      # --- CHANGED SECTION END ---