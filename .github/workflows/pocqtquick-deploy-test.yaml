name: QA Build (Release Branch)

# TRIGGER: Only runs when code is merged to 'release' branch
on:
  pull_request:
    types: [closed]
    branches:
      - 'release'

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'
  APP_EXECUTABLE: 'counter_app.exe'
  PACKAGE_DOMAIN: 'com.pocqtquick'
  BUILD_EXE_PATH: 'build/source/Release/counter_app.exe'
  QML_SOURCE_DIR: 'source/ui'

jobs:
  build-qa-artifacts:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh

    steps:
      # 1. SETUP TIMESTAMP & VARIABLES
      - name: Generate Timestamp
        id: time
        run: |
          # Create a clean timestamp: YYYYMMDDHHmm (e.g., 202312161430)
          $ts = Get-Date -Format "yyyyMMddHHmm"
          
          # Define names with "QA" prefix and timestamp
          $zipName = "pocqtquick-QA-$ts-Portable.zip"
          $installerName = "pocqtquick-QA-$ts-Installer.exe"
          
          # Save to ENV for later steps
          echo "TIMESTAMP=$ts" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "INSTALLER_NAME=$installerName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          
          Write-Host "Build Timestamp: $ts"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt and IFW
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'
          tools: 'tools_ifw'

      - name: Configure and Build Application
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure

      # 2. PREPARE THE APP FOLDER
      - name: Stage Files for Installer
        run: |
          $targetDir = "installer\packages\$env:PACKAGE_DOMAIN\data"
          New-Item -ItemType Directory -Force -Path $targetDir
          Copy-Item -Path "$env:BUILD_EXE_PATH" -Destination $targetDir

      - name: Run Windeployqt
        run: |
          $targetExe = "installer\packages\$env:PACKAGE_DOMAIN\data\$env:APP_EXECUTABLE"
          windeployqt --release --compiler-runtime --no-translations --no-opengl-sw --qmldir $env:QML_SOURCE_DIR $targetExe

      # 3. CREATE THE PORTABLE ZIP (For quick QA)
      - name: Create Portable Zip
        run: |
          $sourceDir = "installer\packages\$env:PACKAGE_DOMAIN\data"
          $destZip = "installer\$env:ZIP_NAME"
          
          Write-Host "Zipping portable app to: $destZip"
          Compress-Archive -Path "$sourceDir\*" -DestinationPath $destZip

      # 4. CREATE THE INSTALLER
      - name: Create Installer
        run: |
          $binCreator = Get-ChildItem -Path "..\Qt\Tools\QtInstallerFramework\*\bin\binarycreator.exe" | Select-Object -First 1 -ExpandProperty FullName

          if (-not $binCreator) {
            Write-Error "binarycreator.exe not found!"
            exit 1
          }
          
          Write-Host "Building Installer: $env:INSTALLER_NAME"
          
          cd installer
          & $binCreator -c config\config.xml -p packages\ $env:INSTALLER_NAME

      # 5. UPLOAD ARTIFACTS (Downloadable from Actions Tab)
      - name: Upload QA Artifacts
        uses: actions/upload-artifact@v4
        with:
          # This name appears in the UI
          name: QA-Build-${{ env.TIMESTAMP }}
          path: |
            installer/${{ env.INSTALLER_NAME }}
            installer/${{ env.ZIP_NAME }}
          retention-days: 5 # Deletes files after 5 days to save storage