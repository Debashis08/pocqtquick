name: pocqtquick-validate

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - release
      - main
  workflow_dispatch:

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'

jobs:
  # JOB 1: VALIDATE BRANCH POLICY (Formerly enforce-branch-strategy)
  validate-branch-policy:
    runs-on: ubuntu-latest
    steps:
      # --- SCENARIO A: Pull Request Checks ---
      - name: Block invalid PR path
        if: |
          github.event_name == 'pull_request' &&
          !((startsWith(github.event.pull_request.head.ref, 'feature-') && github.event.pull_request.base.ref == 'release') || 
            (github.event.pull_request.head.ref == 'release' && github.event.pull_request.base.ref == 'main'))
        run: |
          echo "::error::Invalid PR Path. Allowed: 'feature-* -> release' or 'release -> main'."
          exit 1

      - name: Approve valid PR path
        if: |
          github.event_name == 'pull_request' &&
          ((startsWith(github.event.pull_request.head.ref, 'feature-') && github.event.pull_request.base.ref == 'release') || 
           (github.event.pull_request.head.ref == 'release' && github.event.pull_request.base.ref == 'main'))
        run: echo "PR Path Validated."

     # --- SCENARIO B: Manual Run Checks (Updated) ---
      # Logic: If it is a manual trigger, always allow it.
      - name: Approve Manual Run
        if: github.event_name == 'workflow_dispatch'
        run: echo "Manual validation run initiated on branch '${{ github.ref_name }}'"

  # JOB 2: LINT CODE
  lint-code:
    needs: validate-branch-policy
    runs-on: windows-2022 
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run Linter
        shell: pwsh
        run: |
          Write-Host "Running Lint Checks..."
          # cmake --build build --target check-format
          Write-Host "Linting passed."

  # JOB 3: BUILD APP
  build-app:
    needs: lint-code
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Configure and Build
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-app
          path: build/
          retention-days: 1

  # JOB 4: UNIT TESTS
  run-unit-tests:
    needs: build-app
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: compiled-app
          path: build

      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure