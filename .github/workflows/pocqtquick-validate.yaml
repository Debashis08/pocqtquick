name: pocqtquick-validate

# Triggers when a PR is opened or updated, targeting 'release' OR 'main'
on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - release
      - main

env:
  QT_VERSION: '6.10.1'
  QT_ARCH: 'win64_msvc2022_64'
  APP_EXECUTABLE: 'counter_app.exe'
  PACKAGE_DOMAIN: 'com.pocqtquick'
  # Note: PowerShell uses backslashes for paths inside the script if you prefer, 
  # but forward slashes usually work in cmake too.
  BUILD_EXE_PATH: 'build/source/Release/counter_app.exe' 
  QML_SOURCE_DIR: 'source/ui'

jobs:

  enforce-branch-strategy:
    runs-on: windows-2022
    steps:
      - name: Block invalid PR path
        # This step ONLY runs if the path is INVALID
        # Wrap the entire logical operation in ${{...}}
        if: ${{ !((startsWith(github.event.pull_request.head.ref, 'feature-') && github.event.pull_request.base.ref == 'release') || (github.event.pull_request.head.ref == 'release' && github.event.pull_request.base.ref == 'main')) }}
        run: |
          echo "::error:: This PR path (${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}) is not allowed."
          echo "::error:: Allowed paths are: 'feature-*' -> 'release' OR 'release' -> 'main'."
          exit 1
      
      - name: Approve valid PR path
        # This step ONLY runs if the path is VALID (for logging)
        if: (startsWith(github.event.pull_request.head.ref, 'feature-') && github.event.pull_request.base.ref == 'release') || (github.event.pull_request.head.ref == 'release' && github.event.pull_request.base.ref == 'main')
        run: |
          echo "Valid PR path. Proceeding to build and test..."

  lint-build-test:
    needs: enforce-branch-strategy
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          aqtversion: '>=3.1.6'
          modules: 'qt5compat'

      - name: Configure and Build Application
        run: |
          mkdir build
          cd build
          # PowerShell handles CMake fine
          cmake .. -G "Visual Studio 17 2022" -A x64
          cmake --build . --config Release

      - name: Run Unit Tests
        run: |
          cd build
          ctest -C Release --output-on-failure